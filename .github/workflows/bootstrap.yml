name: AWS Bootstrap (one-time)
on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: AWS region
        default: eu-north-1
        required: true
      tf_backend_bucket:
        description: S3 bucket name for Terraform state (must be globally unique)
        required: true
      tf_lock_table:
        description: DynamoDB lock table name (e.g., daily-quote-tflock)
        default: daily-quote-tflock
        required: true
      oidc_role_name:
        description: IAM role name that GitHub Actions will assume
        default: github-actions-daily-quote
        required: true
      branch:
        description: Protected branch that can deploy
        default: main
        required: true

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ inputs.aws_region }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS (temporary keys)
        # ðŸ” Set these in: Settings â†’ Secrets and variables â†’ Actions
        #   AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY (optionally AWS_SESSION_TOKEN)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Account ID
        id: acct
        run: echo "id=$(aws sts get-caller-identity --query Account --output text)" >> "$GITHUB_OUTPUT"

      - name: Ensure S3 backend bucket
        run: |
          set -e
          BUCKET="${{ inputs.tf_backend_bucket }}"
          REGION="${{ env.AWS_REGION }}"
          if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            echo "Bucket exists: $BUCKET"
          else
            aws s3api create-bucket \
              --bucket "$BUCKET" \
              --region "$REGION" \
              --create-bucket-configuration LocationConstraint="$REGION"
            aws s3api put-bucket-versioning --bucket "$BUCKET" --versioning-configuration Status=Enabled
            aws s3api put-bucket-encryption --bucket "$BUCKET" --server-side-encryption-configuration \
              '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
          fi

      - name: Ensure DynamoDB lock table
        run: |
          set -e
          TABLE="${{ inputs.tf_lock_table }}"
          if aws dynamodb describe-table --table-name "$TABLE" >/dev/null 2>&1; then
            echo "DynamoDB table exists: $TABLE"
          else
            aws dynamodb create-table \
              --table-name "$TABLE" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST
            aws dynamodb wait table-exists --table-name "$TABLE"
          fi

      - name: Ensure GitHub OIDC provider (once per account)
        run: |
          set -e
          # Create if missing (ignore if already exists)
          aws iam create-open-id-connect-provider \
            --url https://token.actions.githubusercontent.com \
            --client-id-list sts.amazonaws.com \
            --thumbprint-list 6938fd4d98bab03faadb97b34396831e3780aea1 \
            >/dev/null 2>&1 || true

      - name: Create IAM role for GitHub OIDC
        id: role
        env:
          ACCOUNT_ID: ${{ steps.acct.outputs.id }}
          ROLE_NAME: ${{ inputs.oidc_role_name }}
          BRANCH: ${{ inputs.branch }}
        run: |
          set -e
          OWNER_REPO="${GITHUB_REPOSITORY}" # e.g. gabriel-ejiro/daily-quote
          TRUST=$(cat <<'JSON'
          {
            "Version": "2012-10-17",
            "Statement": [{
              "Effect": "Allow",
              "Principal": { "Federated": "arn:aws:iam::ACCOUNT_ID:oidc-provider/token.actions.githubusercontent.com" },
              "Action": "sts:AssumeRoleWithWebIdentity",
              "Condition": {
                "StringEquals": {
                  "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
                },
                "StringLike": {
                  "token.actions.githubusercontent.com:sub": "repo:OWNER_REPO:ref:refs/heads/BRANCH"
                }
              }
            }]
          }
          JSON
          )
          TRUST="${TRUST/ACCOUNT_ID/$ACCOUNT_ID}"
          TRUST="${TRUST/OWNER_REPO/$OWNER_REPO}"
          TRUST="${TRUST/BRANCH/$BRANCH}"
          echo "$TRUST" > /tmp/trust.json

          if aws iam get-role --role-name "$ROLE_NAME" >/dev/null 2>&1; then
            echo "Role exists: $ROLE_NAME"
          else
            aws iam create-role --role-name "$ROLE_NAME" --assume-role-policy-document file:///tmp/trust.json >/dev/null
          fi

          POLICY_DOC=$(cat <<'JSON'
          {
            "Version": "2012-10-17",
            "Statement": [
              { "Effect": "Allow", "Action": ["apigateway:*","apigatewayv2:*"], "Resource": "*" },
              { "Effect": "Allow", "Action": ["lambda:*"], "Resource": "*" },
              { "Effect": "Allow", "Action": ["dynamodb:*"], "Resource": "*" },
              { "Effect": "Allow", "Action": ["events:*"], "Resource": "*" },
              { "Effect": "Allow", "Action": ["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents","logs:DescribeLogGroups","logs:DescribeLogStreams","logs:DeleteLogGroup"], "Resource":"*" },
              { "Effect": "Allow", "Action": [
                  "iam:PassRole","iam:GetRole","iam:UpdateAssumeRolePolicy",
                  "iam:CreatePolicy","iam:DeletePolicy","iam:AttachRolePolicy","iam:DetachRolePolicy",
                  "iam:PutRolePolicy","iam:DeleteRolePolicy","iam:GetPolicy","iam:GetPolicyVersion",
                  "iam:CreatePolicyVersion","iam:ListPolicyVersions","iam:DeletePolicyVersion"
                ],
                "Resource": "*"
              }
            ]
          }
          JSON
          )
          echo "$POLICY_DOC" > /tmp/perm.json

          # Create or reuse a managed policy
          POLICY_ARN="arn:aws:iam::${ACCOUNT_ID}:policy/daily-quote-deploy-policy"
          if ! aws iam get-policy --policy-arn "$POLICY_ARN" >/dev/null 2>&1; then
            aws iam create-policy --policy-name daily-quote-deploy-policy --policy-document file:///tmp/perm.json >/dev/null
          fi
          aws iam attach-role-policy --role-name "$ROLE_NAME" --policy-arn "$POLICY_ARN" >/dev/null

          echo "role_arn=arn:aws:iam::${ACCOUNT_ID}:role/${ROLE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Echo outputs (save these as repo secrets/vars)
        run: |
          echo "ACCOUNT_ID: ${{ steps.acct.outputs.id }}"
          echo "ROLE_ARN  : ${{ steps.role.outputs.role_arn }}"
          echo "TF_BUCKET : ${{ inputs.tf_backend_bucket }}"
          echo "TF_TABLE  : ${{ inputs.tf_lock_table }}"
          echo "Region    : ${{ env.AWS_REGION }}"
          echo ""
          echo "Next steps:"
          echo "- Add repo secrets: AWS_ACCOUNT_ID, AWS_OIDC_ROLE (the role name),"
          echo "  and repo variables: TF_BACKEND_BUCKET, TF_LOCK_TABLE, AWS_REGION"
          echo "- Then run the normal Deploy workflow."
